<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Data from sensors</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 24px;
      }
      #controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }
      #curve_chart {
        width: 100%;
        height: 420px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 16px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background: #f5f5f5;
      }
      .muted {
        color: #666;
      }
      .fan-controls {
        background: #f0f0f0;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .slider-container {
        margin: 15px 0;
      }
      .slider-container label {
        display: block;
        font-weight: bold;
        margin-bottom: 10px;
      }
      
      .range-slider {
        position: relative;
        width: 100%;
        height: 50px;
        margin: 20px 0;
      }

      .range-slider input[type="range"] {
        position: absolute;
        width: 100%;
        height: 8px;
        background: transparent;
        pointer-events: none;
        -webkit-appearance: none;
        margin: 0;
      }

      .range-slider input[type="range"]::-webkit-slider-thumb {
        pointer-events: all;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #4caf50;
        cursor: pointer;
        -webkit-appearance: none;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      .range-slider input[type="range"]::-moz-range-thumb {
        pointer-events: all;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #4caf50;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      .range-track {
        position: absolute;
        width: 100%;
        height: 8px;
        background: #ddd;
        border-radius: 4px;
        top: 20px;
      }

      .range-fill {
        position: absolute;
        height: 8px;
        background: #4caf50;
        border-radius: 4px;
        top: 20px;
      }

      .range-values {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-weight: bold;
        font-size: 16px;
      }
      
      .fan-controls button {
        background: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }
      .fan-controls button:hover {
        background: #45a049;
      }
    </style>
  </head>
  <body>
    <h1>Data from sensors</h1>

    <div class="fan-controls">
      <h2>Fan Control (Temperature Range)</h2>

      <div class="slider-container">
        <label>Temperature Range (°C):</label>
        
        <div class="range-slider">
          <div class="range-track"></div>
          <div class="range-fill" id="rangeFill"></div>
          <input type="range" id="minTemp" min="20" max="80" value="20" step="1">
          <input type="range" id="maxTemp" min="20" max="80" value="50" step="1">
        </div>
        
        <div class="range-values">
          <span>Min: <span id="minTempValue">20</span>°C</span>
          <span>Max: <span id="maxTempValue">50</span>°C</span>
        </div>
      </div>

      <button id="applyFanBtn">Apply Settings</button>
      <span id="fanStatus" class="muted"></span>
    </div>

    <div id="controls">
      <label>
        <span class="muted">From:</span>
        <input type="datetime-local" id="fromInput" />
      </label>
      <label>
        <span class="muted">To:</span>
        <input type="datetime-local" id="toInput" />
      </label>
      <label>
        <span class="muted">Limit:</span>
        <input type="number" id="limitInput" value="200" min="1" max="10000" />
      </label>
      <button id="reloadBtn">Reload</button>
      <label>
        <input type="checkbox" id="autoRefresh" checked />
        <span class="muted">Auto refresh (15s)</span>
      </label>
    </div>

    <div id="curve_chart"></div>
    <div id="output" class="muted"></div>

    <table id="dataTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Temperature (°C)</th>
          <th>Humidity (%)</th>
          <th>LED Temp (°C)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const API_BASE = "";
      const API_URL = `${API_BASE}/api/sensors`;
      const COMMAND_URL = `${API_BASE}/api/command`;

      google.charts.load("current", { packages: ["corechart"] });

      const fromInput = document.getElementById("fromInput");
      const toInput = document.getElementById("toInput");
      const limitInput = document.getElementById("limitInput");
      const reloadBtn = document.getElementById("reloadBtn");
      const autoRefresh = document.getElementById("autoRefresh");
      const tableBody = document.querySelector("#dataTable tbody");
      const output = document.getElementById("output");

      const minTempInput = document.getElementById("minTemp");
      const maxTempInput = document.getElementById("maxTemp");
      const minTempValue = document.getElementById("minTempValue");
      const maxTempValue = document.getElementById("maxTempValue");
      const rangeFill = document.getElementById("rangeFill");
      const applyFanBtn = document.getElementById("applyFanBtn");
      const fanStatus = document.getElementById("fanStatus");

      // Leave From/To empty by default to show last 200 records
      // When date range is selected, limit is disabled
      
      function updateLimitState() {
        const hasDateRange = fromInput.value && toInput.value;
        limitInput.disabled = hasDateRange;
        if (hasDateRange) {
          limitInput.style.opacity = '0.5';
          limitInput.style.cursor = 'not-allowed';
        } else {
          limitInput.style.opacity = '1';
          limitInput.style.cursor = 'text';
        }
      }

      fromInput.addEventListener('change', updateLimitState);
      toInput.addEventListener('change', updateLimitState);
      
      // Initialize
      updateLimitState();

      function toLocalDatetimeLocal(d) {
        const pad = (n) => String(n).padStart(2, "0");
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth() + 1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mi = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }

      function datetimeLocalToIso(s) {
        if (!s) return null;
        const d = new Date(s);
        const pad = (n) => String(n).padStart(2, "0");
        const yyyy = d.getUTCFullYear();
        const mm = pad(d.getUTCMonth() + 1);
        const dd = pad(d.getUTCDate());
        const hh = pad(d.getUTCHours());
        const mi = pad(d.getUTCMinutes());
        const ss = pad(d.getUTCSeconds());
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
      }

      function updateRangeSlider() {
        let minVal = parseInt(minTempInput.value);
        let maxVal = parseInt(maxTempInput.value);

        // Prevent overlap
        if (minVal >= maxVal - 1) {
          minVal = maxVal - 1;
          minTempInput.value = minVal;
        }

        if (maxVal <= minVal + 1) {
          maxVal = minVal + 1;
          maxTempInput.value = maxVal;
        }

        // Update display values
        minTempValue.textContent = minVal;
        maxTempValue.textContent = maxVal;

        // Update visual fill
        const percent1 = ((minVal - 20) / 60) * 100;
        const percent2 = ((maxVal - 20) / 60) * 100;
        
        rangeFill.style.left = percent1 + '%';
        rangeFill.style.width = (percent2 - percent1) + '%';
      }

      minTempInput.addEventListener('input', updateRangeSlider);
      maxTempInput.addEventListener('input', updateRangeSlider);

      // Initialize range slider
      updateRangeSlider();

      async function loadAndRender() {
        try {
          const params = new URLSearchParams();
          const fromStr = datetimeLocalToIso(fromInput.value);
          const toStr = datetimeLocalToIso(toInput.value);
          const limit = Number(limitInput.value || 200);

          if (fromStr) params.set("from", fromStr);
          if (toStr) params.set("to", toStr);
          params.set("limit", limit);

          const url = `${API_URL}?${params.toString()}`;
          output.textContent = `Loading ${url} ...`;

          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const rows = await res.json();

          output.textContent = `Loaded ${rows.length} rows`;

          google.charts.setOnLoadCallback(() => drawChart(rows));
          renderTable(rows);
        } catch (err) {
          console.error(err);
          output.textContent = `Error: ${err.message}`;
        }
      }

      function drawChart(rows) {
        if (rows.length === 0) {
          document.getElementById("curve_chart").innerHTML = "<p>No data to display</p>";
          return;
        }

        const data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Time');
        data.addColumn('number', 'Temperature (°C)');
        data.addColumn('number', 'Humidity (%)');
        data.addColumn('number', 'LED Temp (°C)');

        for (const r of rows) {
          const date = new Date(r.date.replace(" ", "T") + "Z");
          const t = Number(r.temperature);
          const h = Number(r.humidity);
          const lt = Number(r.led_temp);
          
          if (!isNaN(date.getTime()) && !Number.isNaN(t) && !Number.isNaN(h) && !Number.isNaN(lt)) {
            data.addRow([date, t, h, lt]);
          }
        }

        const options = {
          title: "Temperature, Humidity & LED Temp Over Time",
          legend: { position: "bottom" },
          hAxis: { 
            title: "Time", 
            format: "HH:mm",
            gridlines: { count: 10 }
          },
          vAxes: {
            0: { title: "Temperature (°C)" },
            1: { title: "Humidity (%)" },
          },
          series: {
            0: { targetAxisIndex: 0, color: '#dc3912' },
            1: { targetAxisIndex: 1, color: '#3366cc' },
            2: { targetAxisIndex: 0, color: '#ff9900' },
          },
          curveType: "function",
          width: "100%",
          height: 420,
        };

        const chart = new google.visualization.LineChart(
          document.getElementById("curve_chart"),
        );
        chart.draw(data, options);
      }

      function renderTable(rows) {
        tableBody.innerHTML = "";
        for (const r of rows) {
          const date = new Date(r.date.replace(" ", "T") + "Z");
          const localDate = date.toLocaleString();

          const tr = document.createElement("tr");
          tr.innerHTML = `
                  <td>${r.id}</td>
                  <td>${localDate}</td>
                  <td>${Number(r.temperature).toFixed(2)}</td>
                  <td>${Number(r.humidity).toFixed(2)}</td>
                  <td>${Number(r.led_temp).toFixed(2)}</td>
              `;
          tableBody.appendChild(tr);
        }
      }

      applyFanBtn.addEventListener("click", async () => {
        const minTemp = parseInt(minTempInput.value);
        const maxTemp = parseInt(maxTempInput.value);

        fanStatus.textContent = "Sending...";

        try {
          const res = await fetch(COMMAND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              type: "fan_limits",
              min_temp: minTemp,
              max_temp: maxTemp,
            }),
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          fanStatus.textContent = "Command sent!";
          setTimeout(() => {
            fanStatus.textContent = "";
          }, 3000);
        } catch (err) {
          console.error(err);
          fanStatus.textContent = `Error: ${err.message}`;
        }
      });

      reloadBtn.addEventListener("click", loadAndRender);

      setInterval(() => {
        if (autoRefresh.checked) loadAndRender();
      }, 15000);

      loadAndRender();
    </script>
  </body>
</html>