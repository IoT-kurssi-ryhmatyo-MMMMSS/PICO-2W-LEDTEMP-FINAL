<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Data from sensors</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      :root {
        --accent: #639cd4;  // #4caf50;
        --accent-light: #f0f8f0;
        --danger: #f44336;
        --danger-light: #fff5f5;
        --border-soft: #ccc;
        --border-soft-alt: #ddd;
      }

      /* Base layout */
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 24px;
      }

      h1, h2 {
        text-align: center;
      }

      /* Main container blocks */
      #controls,
      #output,
      .fan-controls {
        width: 100%;
        max-width: none;
        margin-left: auto;
        margin-right: auto;
      }

      /* Controls layout */
      #controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      /* Chart container */
      #curve_chart {
        width: 100%;
        height: 420px;
        max-width: none;
        margin-left: auto;
        margin-right: auto;
      }

      /* Responsive breakpoints */
      @media (min-width: 1024px) {
        #controls,
        #output,
        .fan-controls {
          width: 80%;
        }

        #curve_chart {
          width: 95%;
        }
      }

      @media (min-width: 1356px) {
        #controls,
        #output,
        .fan-controls {
          width: 60%;
        }

        #curve_chart {
          width: 90%;
        }
      }

      /* Labels inside controls */
      #controls label {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Date filter block */
      #controls .date-filter {
        position: relative;
        padding: 8px;
        border: 2px solid transparent;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      #controls .date-filter.active {
        border-color: var(--accent);
        background: var(--accent-light);
      }

      /* Shared input styles */
      #controls select,
      #controls input[type="date"],
      .dt-display,
      .dt-popup-row input[type="date"],
      .dt-popup-row input[type="number"] {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid var(--border-soft-alt);
        font-size: 14px;
      }

      /* Datetime display field */
      .dt-display {
        width: 160px;
        padding: 6px 10px;
        cursor: pointer;
        background: #fff;
        border-radius: 6px;
        border-color: var(--border-soft);
      }

      /* Popup container */
      .dt-popup {
        position: absolute;
        left: 0;
        top: 100%;
        margin-top: 4px;
        background: #fff;
        border: 1px solid var(--border-soft);
        border-radius: 8px;
        padding: 10px;
        display: none;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        z-index: 1000;
      }

      /* Rows inside popup */
      .dt-popup-row {
        display: flex;
        gap: 6px;
        align-items: center;
      }

      /* Popup buttons */
      .dt-popup-row button {
        padding: 4px 10px;
        border-radius: 4px;
        border: 1px solid var(--border-soft-alt);
        background: #f3f3f3;
        cursor: pointer;
        font-size: 13px;
      }

      .dt-popup-row button:hover {
        background: #e8e8e8;
      }

      /* Control buttons */
      #controls button {
        padding: 8px 16px;
        border-radius: 6px;
        border: 2px solid var(--accent);
        background: #fff;
        color: var(--accent);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }

      #controls button:hover {
        background: var(--accent-light);
      }

      /* Clear button (danger) */
      #controls #clearAllBtn {
        border-color: var(--danger);
        color: var(--danger);
      }

      #controls #clearAllBtn:hover {
        background: var(--danger-light);
      }

      /* Table styles */
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 16px;
      }

      th,
      td {
        border: 1px solid var(--border-soft-alt);
        padding: 8px;
        text-align: left;
      }

      th {
        background: #f5f5f5;
      }

      /* Muted text */
      .muted {
        color: #666;
      }

      /* Fan control container */
      .fan-controls {
        background: #f0f0f0;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      /* Slider wrapper */
      .slider-container {
        margin: 15px 0;
      }

      .slider-container label {
        display: block;
        font-weight: bold;
        margin-bottom: 10px;
      }

      /* Range slider main block */
      .range-slider {
        position: relative;
        width: 100%;
        height: 50px;
        margin: 20px 0;
      }

      /* Range input */
      .range-slider input[type="range"] {
        position: absolute;
        width: 100%;
        height: 8px;
        background: transparent;
        pointer-events: none;
        -webkit-appearance: none;
        margin: 0;
      }

      /* Slider thumb (WebKit) */
      .range-slider input[type="range"]::-webkit-slider-thumb {
        pointer-events: all;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        -webkit-appearance: none;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* Slider thumb (Firefox) */
      .range-slider input[type="range"]::-moz-range-thumb {
        pointer-events: all;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--accent);
        cursor: pointer;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      /* Slider track and fill */
      .range-track,
      .range-fill {
        position: absolute;
        height: 8px;
        border-radius: 4px;
        top: 20px;
      }

      .range-track {
        width: 100%;
        background: #ddd;
      }

      .range-fill {
        background: var(--accent);
      }

      /* Fan action button */
      .fan-controls button {
        background: var(--accent);
        color: #fff;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      .fan-controls button:hover {
        background: #45a049;
      }
    </style>
  </head>
  <body>
    <h1>Data from sensors</h1>

    <div class="fan-controls container">
      <h2>Fan Control (Temperature Range)</h2>

      <div class="slider-container">
        <label>Temperature Range (°C):</label>

        <div class="range-slider">
          <div class="range-track"></div>
          <div class="range-fill" id="rangeFill"></div>
          <input
            type="range"
            id="minTemp"
            min="20"
            max="80"
            value="20"
            step="1"
          />
          <input
            type="range"
            id="maxTemp"
            min="20"
            max="80"
            value="50"
            step="1"
          />
        </div>

        <div class="range-values">
          <span>Min: <span id="minTempValue">20</span>°C</span>
          <span>Max: <span id="maxTempValue">50</span>°C</span>
        </div>
      </div>

      <button id="applyFanBtn">Apply Settings</button>
      <span id="fanStatus" class="muted"></span>
    </div>

    <div id="controls" class="container">
      <div class="date-filter" id="fromFilter">
        <label>
          <span class="muted">From:</span>
          <input
            type="text"
            id="fromDisplay"
            class="dt-display"
            placeholder="YYYY-MM-DD HH:MM"
            readonly
          />
          <div class="dt-popup" id="fromPopup">
            <div class="dt-popup-row">
              <input id="fromDate" type="date" />
              <input id="fromHour" type="number" min="0" max="23" value="0" />
              <span>:</span>
              <input id="fromMinute" type="number" min="0" max="59" value="0" />
              <button type="button" id="fromClear">Clear</button>
              <button type="button" id="fromNow">Now</button>
            </div>
          </div>
        </label>
      </div>
      <div class="date-filter" id="toFilter">
        <label>
          <span class="muted">To:</span>
          <input
            type="text"
            id="toDisplay"
            class="dt-display"
            placeholder="YYYY-MM-DD HH:MM"
            readonly
          />
          <div class="dt-popup" id="toPopup">
            <div class="dt-popup-row">
              <input id="toDate" type="date" />
              <input id="toHour" type="number" min="0" max="23" value="23" />
              <span>:</span>
              <input id="toMinute" type="number" min="0" max="59" value="59" />
              <button type="button" id="toClear">Clear</button>
              <button type="button" id="toNow">Now</button>
            </div>
          </div>
        </label>
      </div>
      <label>
        <span class="muted">Limit:</span>
        <input type="number" id="limitInput" value="200" min="1" max="10000" />
      </label>
      <button id="reloadBtn">Reload</button>
      <button id="clearAllBtn">Clear All</button>
      <label>
        <input type="checkbox" id="autoRefresh" checked />
        <span class="muted">Auto refresh (15s)</span>
      </label>
    </div>

    <div id="curve_chart" class="container-wide"></div>
    <div id="output" class="muted container"></div>

    <table id="dataTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Date</th>
          <th>Temperature (°C)</th>
          <th>Humidity (%)</th>
          <th>LED Temp (°C)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const API_BASE = "";
      const API_URL = `${API_BASE}/api/sensors`;
      const COMMAND_URL = `${API_BASE}/api/command`;

      google.charts.load("current", { packages: ["corechart"] });

      // DateTime Picker Elements
      const fromDisplay = document.getElementById("fromDisplay");
      const fromPopup = document.getElementById("fromPopup");
      const fromDate = document.getElementById("fromDate");
      const fromHour = document.getElementById("fromHour");
      const fromMinute = document.getElementById("fromMinute");
      const fromClear = document.getElementById("fromClear");
      const fromNow = document.getElementById("fromNow");

      const toDisplay = document.getElementById("toDisplay");
      const toPopup = document.getElementById("toPopup");
      const toDate = document.getElementById("toDate");
      const toHour = document.getElementById("toHour");
      const toMinute = document.getElementById("toMinute");
      const toClear = document.getElementById("toClear");
      const toNow = document.getElementById("toNow");

      const limitInput = document.getElementById("limitInput");
      const reloadBtn = document.getElementById("reloadBtn");
      const clearAllBtn = document.getElementById("clearAllBtn");
      const autoRefresh = document.getElementById("autoRefresh");
      const tableBody = document.querySelector("#dataTable tbody");
      const output = document.getElementById("output");

      const fromFilter = document.getElementById("fromFilter");
      const toFilter = document.getElementById("toFilter");

      const minTempInput = document.getElementById("minTemp");
      const maxTempInput = document.getElementById("maxTemp");
      const minTempValue = document.getElementById("minTempValue");
      const maxTempValue = document.getElementById("maxTempValue");
      const rangeFill = document.getElementById("rangeFill");
      const applyFanBtn = document.getElementById("applyFanBtn");
      const fanStatus = document.getElementById("fanStatus");

      // Helper functions
      function pad2(v) {
        return String(v).padStart(2, "0");
      }

      function clampNumber(input, min, max) {
        let v = parseInt(input.value, 10);
        if (isNaN(v)) v = min;
        if (v < min) v = min;
        if (v > max) v = max;
        input.value = v;
      }

      // Load saved state on page load
      const savedAutoRefresh = localStorage.getItem("autoRefresh");
      if (savedAutoRefresh !== null) {
        autoRefresh.checked = savedAutoRefresh === "true";
      }

      // Save state when changed
      autoRefresh.addEventListener("change", () => {
        localStorage.setItem("autoRefresh", autoRefresh.checked);
      });

      function updateDisplay(display, dateInput, hourInput, minuteInput) {
        if (!dateInput.value) {
          display.value = "";
          return;
        }
        clampNumber(hourInput, 0, 23);
        clampNumber(minuteInput, 0, 59);

        const date = dateInput.value;
        const hh = pad2(hourInput.value);
        const mm = pad2(minuteInput.value);
        display.value = `${date} ${hh}:${mm}`;
      }

      function setNow(dateInput, hourInput, minuteInput) {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = pad2(d.getMonth() + 1);
        const dd = pad2(d.getDate());
        const hh = d.getHours();
        const mi = d.getMinutes();

        dateInput.value = `${yyyy}-${mm}-${dd}`;
        hourInput.value = hh;
        minuteInput.value = mi;
      }

      // From picker
      fromDisplay.addEventListener("click", () => {
        fromPopup.style.display = "block";
        toPopup.style.display = "none";
      });

      fromDate.addEventListener("input", () => {
        updateDisplay(fromDisplay, fromDate, fromHour, fromMinute);
        updateFilterVisuals();
      });
      fromHour.addEventListener("input", () =>
        updateDisplay(fromDisplay, fromDate, fromHour, fromMinute),
      );
      fromMinute.addEventListener("input", () =>
        updateDisplay(fromDisplay, fromDate, fromHour, fromMinute),
      );

      fromClear.addEventListener("click", () => {
        fromDate.value = "";
        fromHour.value = 0;
        fromMinute.value = 0;
        fromDisplay.value = "";
        fromPopup.style.display = "none";
        updateFilterVisuals();
      });

      fromNow.addEventListener("click", () => {
        setNow(fromDate, fromHour, fromMinute);
        updateDisplay(fromDisplay, fromDate, fromHour, fromMinute);
        fromPopup.style.display = "none";
        updateFilterVisuals();
      });

      // To picker
      toDisplay.addEventListener("click", () => {
        toPopup.style.display = "block";
        fromPopup.style.display = "none";
      });

      toDate.addEventListener("input", () => {
        updateDisplay(toDisplay, toDate, toHour, toMinute);
        updateFilterVisuals();
      });
      toHour.addEventListener("input", () =>
        updateDisplay(toDisplay, toDate, toHour, toMinute),
      );
      toMinute.addEventListener("input", () =>
        updateDisplay(toDisplay, toDate, toHour, toMinute),
      );

      toClear.addEventListener("click", () => {
        toDate.value = "";
        toHour.value = 23;
        toMinute.value = 59;
        toDisplay.value = "";
        toPopup.style.display = "none";
        updateFilterVisuals();
      });

      toNow.addEventListener("click", () => {
        setNow(toDate, toHour, toMinute);
        updateDisplay(toDisplay, toDate, toHour, toMinute);
        toPopup.style.display = "none";
        updateFilterVisuals();
      });

      // Close popups on outside click
      document.addEventListener("click", (e) => {
        if (
          !fromPopup.contains(e.target) &&
          e.target !== fromDisplay &&
          !fromFilter.contains(e.target)
        ) {
          fromPopup.style.display = "none";
        }
        if (
          !toPopup.contains(e.target) &&
          e.target !== toDisplay &&
          !toFilter.contains(e.target)
        ) {
          toPopup.style.display = "none";
        }
      });

      function updateFilterVisuals() {
        if (fromDisplay.value) {
          fromFilter.classList.add("active");
        } else {
          fromFilter.classList.remove("active");
        }

        if (toDisplay.value) {
          toFilter.classList.add("active");
        } else {
          toFilter.classList.remove("active");
        }

        updateLimitState();
      }

      function updateLimitState() {
        const hasFullDateRange = fromDisplay.value && toDisplay.value;
        limitInput.disabled = hasFullDateRange;
        if (hasFullDateRange) {
          limitInput.style.opacity = "0.5";
          limitInput.style.cursor = "not-allowed";
        } else {
          limitInput.style.opacity = "1";
          limitInput.style.cursor = "text";
        }
      }

      clearAllBtn.addEventListener("click", () => {
        fromDate.value = "";
        fromHour.value = 0;
        fromMinute.value = 0;
        fromDisplay.value = "";
        toDate.value = "";
        toHour.value = 23;
        toMinute.value = 59;
        toDisplay.value = "";
        limitInput.value = "200";
        updateFilterVisuals();
        loadAndRender();
      });

      updateFilterVisuals();

      function combineDateTimeToIso(displayValue) {
        if (!displayValue) return null;
        const [date, time] = displayValue.split(" ");
        if (!date || !time) return null;

        const localDateTime = `${date}T${time}`;
        const d = new Date(localDateTime);
        const pad = (n) => String(n).padStart(2, "0");
        const yyyy = d.getUTCFullYear();
        const mm = pad(d.getUTCMonth() + 1);
        const dd = pad(d.getUTCDate());
        const hh = pad(d.getUTCHours());
        const mi = pad(d.getUTCMinutes());
        const ss = pad(d.getUTCSeconds());
        return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
      }

      function updateRangeSlider() {
        let minVal = parseInt(minTempInput.value);
        let maxVal = parseInt(maxTempInput.value);

        if (minVal >= maxVal - 1) {
          minVal = maxVal - 1;
          minTempInput.value = minVal;
        }

        if (maxVal <= minVal + 1) {
          maxVal = minVal + 1;
          maxTempInput.value = maxVal;
        }

        minTempValue.textContent = minVal;
        maxTempValue.textContent = maxVal;

        const percent1 = ((minVal - 20) / 60) * 100;
        const percent2 = ((maxVal - 20) / 60) * 100;

        rangeFill.style.left = percent1 + "%";
        rangeFill.style.width = percent2 - percent1 + "%";
      }

      minTempInput.addEventListener("input", updateRangeSlider);
      maxTempInput.addEventListener("input", updateRangeSlider);

      updateRangeSlider();

      async function loadAndRender() {
        try {
          const params = new URLSearchParams();
          const fromStr = combineDateTimeToIso(fromDisplay.value);
          const toStr = combineDateTimeToIso(toDisplay.value);
          const limit = Number(limitInput.value || 200);

          // Logic:
          // 1. Both From and To set -> use date range, ignore limit
          // 2. Only From set -> use From + limit
          // 3. Only To set -> use To + limit
          // 4. Neither set -> use limit only (last N records)

          if (fromStr && toStr) {
            // Both dates set - use range, no limit
            params.set("from", fromStr);
            params.set("to", toStr);
          } else if (fromStr && !toStr) {
            // Only From set - use From + limit
            params.set("from", fromStr);
            params.set("limit", limit);
          } else if (!fromStr && toStr) {
            // Only To set - use To + limit
            params.set("to", toStr);
            params.set("limit", limit);
          } else {
            // No dates set - use limit only
            params.set("limit", limit);
          }

          const url = `${API_URL}?${params.toString()}`;
          output.textContent = `Loading ${url} ...`;

          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const rows = await res.json();

          output.textContent = `Loaded ${rows.length} rows`;

          google.charts.setOnLoadCallback(() => drawChart(rows));
          renderTable(rows);
        } catch (err) {
          console.error(err);
          output.textContent = `Error: ${err.message}`;
        }
      }

      function drawChart(rows) {
        if (rows.length === 0) {
          document.getElementById("curve_chart").innerHTML =
            "<p>No data to display</p>";
          return;
        }

        const data = new google.visualization.DataTable();
        data.addColumn("datetime", "Time");
        data.addColumn("number", "Temperature (°C)");
        data.addColumn("number", "Humidity (%)");
        data.addColumn("number", "LED Temp (°C)");

        // Variables to track min/max values
        let minTemp = Infinity;
        let maxTemp = -Infinity;
        let minHumidity = Infinity;
        let maxHumidity = -Infinity;

        for (const r of rows) {
          const date = new Date(r.date.replace(" ", "T") + "Z");
          const t = Number(r.temperature);
          const h = Number(r.humidity);
          const lt = Number(r.led_temp);

          if (
            !isNaN(date.getTime()) &&
            !Number.isNaN(t) &&
            !Number.isNaN(h) &&
            !Number.isNaN(lt)
          ) {
            data.addRow([date, t, h, lt]);

            // Track min/max for temperature and LED temp (both use axis 0)
            minTemp = Math.min(minTemp, t, lt);
            maxTemp = Math.max(maxTemp, t, lt);

            // Track min/max for humidity (uses axis 1)
            minHumidity = Math.min(minHumidity, h);
            maxHumidity = Math.max(maxHumidity, h);
          }
        }

        const options = {
          title: "Temperature, Humidity & LED Temp Over Time",
          legend: { position: "bottom" },
          hAxis: {
            title: "Time",
            format: "HH:mm",
            gridlines: { count: 10 },
          },
          vAxes: {
            0: {
              title: "Temperature (°C)",
              viewWindow: {
                min: minTemp - 1,
                max: maxTemp + 1,
              },
              gridlines: { count: 5 },
              minorGridlines: { count: 2 },
            },
            1: {
              title: "Humidity (%)",
              viewWindow: {
                min: minHumidity - 6,
                max: maxHumidity + 4,
              },
              gridlines: { count: 0 },
              minorGridlines: { count: 0 },
            },
          },
          series: {
            0: { targetAxisIndex: 0, color: "#dc3912" },
            1: { targetAxisIndex: 1, color: "#3366cc" },
            2: { targetAxisIndex: 0, color: "#ff9900" },
          },
          curveType: "function",
          width: "100%",
          height: 420,
          chartArea: { width: "90%", height: "70%" },
        };

        const chart = new google.visualization.LineChart(
          document.getElementById("curve_chart"),
        );
        chart.draw(data, options);
      }

      function renderTable(rows) {
        tableBody.innerHTML = "";

        // Sort by ID descending to show newest records first
        const sortedRows = [...rows].sort((a, b) => b.id - a.id);

        for (const r of sortedRows) {
          const date = new Date(r.date.replace(" ", "T") + "Z");
          const localDate = date.toLocaleString();

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.id}</td>
            <td>${localDate}</td>
            <td>${Number(r.temperature).toFixed(2)}</td>
            <td>${Number(r.humidity).toFixed(2)}</td>
            <td>${Number(r.led_temp).toFixed(2)}</td>
          `;
          tableBody.appendChild(tr);
        }
      }

      applyFanBtn.addEventListener("click", async () => {
        const minTemp = parseInt(minTempInput.value);
        const maxTemp = parseInt(maxTempInput.value);

        fanStatus.textContent = "Sending...";

        try {
          const res = await fetch(COMMAND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              type: "fan_limits",
              min_temp: minTemp,
              max_temp: maxTemp,
            }),
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          fanStatus.textContent = "Command sent!";
          setTimeout(() => {
            fanStatus.textContent = "";
          }, 3000);
        } catch (err) {
          console.error(err);
          fanStatus.textContent = `Error: ${err.message}`;
        }
      });

      reloadBtn.addEventListener("click", loadAndRender);

      setInterval(() => {
        if (autoRefresh.checked) loadAndRender();
      }, 15000);

      loadAndRender();
    </script>
  </body>
</html>
